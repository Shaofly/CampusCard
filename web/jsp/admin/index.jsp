<%--
  Created by IntelliJ IDEA.
  User: msf
  Date: 2025/6/6
  Time: 16:23
  To change this template use File | Settings | File Templates.
--%>
<%@ page contentType="text/html; charset=UTF-8" pageEncoding="UTF-8" %>
<%@ page import="java.util.*" %>
<%@ page import="com.mag.domain.CampusCard" %>
<%
    Locale locale = (Locale) session.getAttribute("locale");
    if (locale == null) {
        locale = request.getLocale();
    }
    ResourceBundle bundle = ResourceBundle.getBundle("messages", locale);
%>

<%-- ÁôªÂΩïÊã¶Êà™ --%>
<%
    if (session.getAttribute("loginCard") == null) {
        response.sendRedirect(request.getContextPath() + "/login.jsp");
        return;
    }
%>

<%-- ÂèñÂèÇÊï∞ --%>
<%
    //ÂèñÂá∫ totalAmount Âíå total
    double totalAmount = (request.getAttribute("totalAmount") != null) ? (double) request.getAttribute("totalAmount") : 0.0;
    int total = (request.getAttribute("total") != null) ? (int)request.getAttribute("total") : 0;

    //ÂèñÂá∫ card
    CampusCard loginCard = (CampusCard) request.getAttribute("loginCard");
%>

<!-- index.jsp ÁÆ°ÁêÜÂëò‰∏ªÈ°µ/ÁªüËÆ°ËßÜÂõæ -->
<!DOCTYPE html>
<html lang="<%= locale.getLanguage() %>">
<head>
    <meta charset="UTF-8"/>
    <title>ÁÆ°ÁêÜÂëò‰∏ªÈ°µ-Ê†°Âõ≠Âç°Á≥ªÁªü</title>
<%--   ÂºïÂÖ•css --%>
    <link rel="stylesheet" href=" <%=request.getContextPath()%>/css/admin/sidebar.css"/>
    <link rel="stylesheet" href=" <%=request.getContextPath()%>/css/admin/main.css"/>
    <link rel="stylesheet" href=" <%=request.getContextPath()%>/css/admin/editModal.css"/>
    <link rel="stylesheet" href="${pageContext.request.contextPath}/css/common/modalOverlay.css"/>
    <link rel="stylesheet" href="${pageContext.request.contextPath}/css/common/horizontalInputRow.css"/>
</head>
<body>
<%-- ‰æßËæπÂØºËà™Ê†è --%>
<aside class="admin-sidebar">
    <div class="admin-logo">
        <img src=" <%=request.getContextPath()%>/img/logo.png" alt="logo">
        <span>Ê†°Âõ≠Âç°Á≥ªÁªü</span>
    </div>
    <nav class="admin-nav">
        <a href="${pageContext.request.contextPath}/AdminIndexServlet?currentPage=1&pageSize=5" class="nav-item active">ÁªüËÆ°ËßÜÂõæ</a>
        <a href="${pageContext.request.contextPath}/CardManageServlet?currentPage=1&pageSize=10" class="nav-item">‰∫∫ÂëòÁÆ°ÁêÜ</a>
        <a href="${pageContext.request.contextPath}/jsp/admin/approval.jsp" class="nav-item">ÂÆ°ÊâπÂ§ÑÁêÜ</a>
    </nav>
    <div class="admin-home">
        <a href="${pageContext.request.contextPath}/UserHomeServlet" class="admin-home-item">
            üè† ÊàëÁöÑ‰∏ªÈ°µ
        </a>
    </div>
    <div class="admin-sidebar-bottom">
        <a href="${pageContext.request.contextPath}/LogoutServlet" class="logout-link">ÈÄÄÂá∫ÁôªÂΩï</a>
    </div>
</aside>
<%-- ËßÜÂõæ‰∏ªË¶ÅÂÜÖÂÆπ --%>
<main class="admin-main">
    <%-- ËßÜÂõæÂ§¥ --%>
    <div class="admin-header">
        <span class="admin-title">ÁªüËÆ°ËßÜÂõæ</span>
        <%-- ËøôÈáåÂèØ‰ª•Âä†ÁÆ°ÁêÜÂëò‰ø°ÊÅØ --%>
        <span class="admin-user-info">Ê¨¢ËøéÔºåÁÆ°ÁêÜÂëò<strong><%= loginCard.getName() %></strong></span>
    </div>
    <%-- ‰ª™Ë°®Áõò --%>
    <div class="admin-dashboard">
        <!-- ÁªüËÆ°Âç°ÁâáÂå∫Âüü -->
        <div class="dashboard-row">
            <div class="dashboard-card">
                <div class="dashboard-value"><%= total %></div>
                <div class="dashboard-label">ÊÄªÂç°ÁâáÊï∞</div>
            </div>
            <div class="dashboard-card">
                <div class="dashboard-value">¬•<%= String.format("%,.2f", totalAmount) %></div>
                <div class="dashboard-label">Ê†°Âõ≠Âç°Á¥ØËÆ°ÈáëÈ¢ù</div>
            </div>
            <div class="dashboard-card abnormal">
                <div class="dashboard-value">2</div>
                <div class="dashboard-label">ÂºÇÂ∏∏Êï∞ÊçÆ</div>
            </div>
        </div>
        <%-- Âç°ÁâáË°®Ê†º ‰∏ÄÈ°µ5Ë°å --%>
        <div class="admin-table-card">
            <div class="table-header">Âç°Áâá‰∏ÄËßà</div>
            <div class="table-content">
                <table class="admin-table">
                    <thead>
                    <tr>
                        <th>Â≠¶Âè∑/Â∑•Âè∑</th>
                        <th>ÂßìÂêç</th>
                        <th>Áä∂ÊÄÅ</th>
                        <th>Êìç‰Ωú</th>
                    </tr>
                    </thead>
                    <tbody>
                    <%
                        List<CampusCard> cardList =
                                (List<CampusCard>) request.getAttribute("cardList");
                        if (cardList != null && !cardList.isEmpty()) {
                            for (CampusCard card : cardList) {
                    %>
                    <tr>
                        <td><%= card.getPersonID() %></td>
                        <td><%= card.getName() %></td>
                        <td><%= card.getStatus() %></td>
                        <td>
                            <button class="edit-btn"
                                    onclick='openAdminEditModal({
                                            cardID: "<%= card.getCardID() %>",
                                            name: "<%= card.getName() %>",
                                            personID: "<%= card.getPersonID() %>",
                                            gender: "<%= card.getGender() %>",
                                            department: "<%= card.getDepartment() %>",
                                            major: "<%= card.getMajor() %>",
                                            status: "<%= card.getStatus() %>",
                                            cardType: "<%= card.getCardType() %>",
                                            campusLocation: "<%= card.getCampusLocation() %>",
                                            role: "<%= card.getRole() %>",
                                            registerDate: "<%= card.getRegisterDateString() %>",
                                            IDNumber: "<%= card.getIDNumber() %>",
                                            password: "<%= card.getPassword() == null ? "" : card.getPassword() %>",
                                            passwordPay: "<%= card.getPasswordPay() == null ? "" : card.getPasswordPay() %>",
                                            phoneNumber: "<%= card.getPhoneNumber() %>",
                                            email: "<%= card.getEmail() %>",
                                            maxLimit: "<%= card.getMaxLimit() %>"
                                            })'>ÁºñËæë</button>
                        </td>
                    </tr>
                    <%
                        }
                    } else {
                    %>
                    <tr><td colspan="4">ÊöÇÊó†Êï∞ÊçÆ</td></tr>
                    <% } %>
                    </tbody>
                </table>
            </div>
            <%-- ÂàÜÈ°µÊéß‰ª∂ --%>
            <div class="pagination">
                <%
                    // Â∑≤Âú®È°µÈù¢ÂºÄÂ§¥Ëé∑ÂèñËøátotalÔºàÊÄªÊù°Êï∞Ôºâ
                    int currentPage = (request.getAttribute("currentPage") != null) ? (int)request.getAttribute("currentPage") : 1;
                    int pageSize = 5;
                    int pageCount = (int) Math.ceil((double) total / pageSize);
                    if (pageCount == 0) pageCount = 1;

                    // ÂàÜÈ°µÊåâÈíÆÊòæÁ§∫‰ºòÂåñÁõ∏ÂÖ≥ÂèÇÊï∞
                    int maxPageShow = 5; // ÊúÄÂ§öËøûÁª≠ÊòæÁ§∫ÁöÑÈ°µÁ†ÅÊï∞
                    // ËÆ°ÁÆóËøûÁª≠ÊòæÁ§∫ÁöÑËµ∑ÂßãÂíåÁªàÊ≠¢È°µÁ†Å
                    int startPage = Math.max(1, currentPage - 2);
                    int endPage = Math.min(pageCount, currentPage + 2);
                    // Â¶ÇÊûúÊòæÁ§∫ÁöÑÈ°µÊï∞‰∏çÂ§ümaxPageShow‰∏™ÔºåËá™Âä®Ë∞ÉÊï¥startÂíåendÔºå‰øùËØÅÊï∞Èáè
                    if (endPage - startPage < maxPageShow - 1) {
                        if (startPage == 1) {
                            endPage = Math.min(pageCount, startPage + maxPageShow - 1);
                        } else if (endPage == pageCount) {
                            startPage = Math.max(1, endPage - maxPageShow + 1);
                        }
                    }
                %>
                <%-- ÊòæÁ§∫ÊÄªÊù°Êï∞ --%>
                <span>ÂÖ± <%= total %> Êù°</span>

                <%-- ‚Äú‰∏ä‰∏ÄÈ°µ‚ÄùÊåâÈíÆÔºåÂΩìÂâçÈ°µ‰∏∫1Êó∂‰∏çÊòæÁ§∫ --%>
                <% if (currentPage > 1) { %>
                <a href="${pageContext.request.contextPath}/AdminIndexServlet?currentPage=<%= currentPage - 1 %>">&lt; ‰∏ä‰∏ÄÈ°µ</a>
                <% } %>

                <%-- Â¶ÇÊûúËµ∑ÂßãÈ°µÂ§ß‰∫é1ÔºåÊòæÁ§∫È¶ñÈ°µÊåâÈíÆÔºàÂπ∂ÂèØËÉΩÂä†ÁúÅÁï•Âè∑Ôºâ --%>
                <% if (startPage > 1) { %>
                <a href="${pageContext.request.contextPath}/AdminIndexServlet?currentPage=1">1</a>
                <%-- Â¶ÇÊûúÁ¨¨‰∏ÄÈ°µÂíåËµ∑ÂßãÈ°µ‰πãÈó¥Ë∂ÖËøá1È°µÔºåÂä†ÁúÅÁï•Âè∑ --%>
                <% if (startPage > 2) { %>
                <span>...</span>
                <% } %>
                <% } %>

                <%-- ÊòæÁ§∫ÂΩìÂâçÈ°µÂèäÂÖ∂ÈôÑËøëÁöÑÈ°µÁ†ÅÊåâÈíÆÔºàÊúÄÂ§ömaxPageShow‰∏™Ôºâ --%>
                <% for (int i = startPage; i <= endPage; i++) { %>
                <% if (i == currentPage) { %>
                <span style="font-weight:bold;"><%= i %></span> <%-- ÂΩìÂâçÈ°µÈ´ò‰∫ÆÊòæÁ§∫ --%>
                <% } else { %>
                <a href="${pageContext.request.contextPath}/AdminIndexServlet?currentPage=<%= i %>"><%= i %></a>
                <% } %>
                <% } %>

                <%-- Â¶ÇÊûúÁªàÊ≠¢È°µÂ∞è‰∫éÊÄªÈ°µÊï∞ÔºåÊòæÁ§∫Êú´È°µÊåâÈíÆÔºàÂπ∂ÂèØËÉΩÂä†ÁúÅÁï•Âè∑Ôºâ --%>
                <% if (endPage < pageCount) { %>
                <%-- Â¶ÇÊûúÁªàÊ≠¢È°µÂíåÊú´È°µ‰πãÈó¥Ë∂ÖËøá1È°µÔºåÂä†ÁúÅÁï•Âè∑ --%>
                <% if (endPage < pageCount - 1) { %>
                <span>...</span>
                <% } %>
                <a href="${pageContext.request.contextPath}/AdminIndexServlet?currentPage=<%= pageCount %>"><%= pageCount %></a>
                <% } %>

                <%-- ‚Äú‰∏ã‰∏ÄÈ°µ‚ÄùÊåâÈíÆÔºåÂΩìÂâçÈ°µ‰∏∫ÊúÄÂêé‰∏ÄÈ°µÊó∂‰∏çÊòæÁ§∫ --%>
                <% if (currentPage < pageCount) { %>
                <a href="${pageContext.request.contextPath}/AdminIndexServlet?currentPage=<%= currentPage + 1 %>">‰∏ã‰∏ÄÈ°µ &gt;</a>
                <% } %>
            </div>
        </div>
    </div>
</main>

<!-- ÁºñËæëÊ†°Âõ≠Âç°‰ø°ÊÅØÂºπÁ™óÔºàÁÆ°ÁêÜÂëò‰∏ìÁî®Ôºâ -->
<div id="admin-edit-modal" class="modal-overlay" style="display: none;">
    <div class="modal-card">
        <h3>ÁºñËæëÊ†°Âõ≠Âç°‰ø°ÊÅØ</h3>
        <form id="admin-edit-form" autocomplete="off">
            <div class="modal-form-grid">
                <!-- Âç°Âè∑ÔºàÂè™ËØªÔºâ -->
                <div class="input-row-horizontal">
                    <label>Âç°Âè∑</label>
                    <input type="text" id="edit-cardID" name="cardID" required readonly>
                </div>
                <!-- ÂßìÂêç -->
                <div class="input-row-horizontal">
                    <label>ÂßìÂêç</label>
                    <input type="text" id="edit-name" name="name" pattern="^[\u4e00-\u9fa5]{1,12}$" title="ÂßìÂêçÂøÖÈ°ª‰∏∫1-12‰ΩçÊ±âÂ≠ó" required>
                </div>
                <!-- Â≠¶Âè∑ -->
                <div class="input-row-horizontal">
                    <label>Â≠¶Âè∑</label>
                    <input type="text" id="edit-personID" name="personID" pattern="\d{10}" title="Â≠¶Âè∑/Â∑•Âè∑ÂøÖÈ°ª‰∏∫10‰ΩçÊï∞Â≠ó" required readonly>
                </div>
                <!-- ÊÄßÂà´ -->
                <div class="input-row-horizontal">
                    <label>ÊÄßÂà´</label>
                    <select id="edit-gender" name="gender" required>
                        <option value="Áî∑">Áî∑</option>
                        <option value="Â•≥">Â•≥</option>
                    </select>
                </div>
                <!-- Â≠¶Èô¢ -->
                <div class="input-row-horizontal">
                    <label>Â≠¶Èô¢</label>
                    <input type="text" id="edit-department" name="department">
                </div>
                <!-- ‰∏ì‰∏ö -->
                <div class="input-row-horizontal">
                    <label>‰∏ì‰∏ö</label>
                    <input type="text" id="edit-major" name="major">
                </div>
                <!-- Áä∂ÊÄÅ -->
                <div class="input-row-horizontal">
                    <label>Áä∂ÊÄÅ</label>
                    <select id="edit-status" name="status" required>
                        <option value="Ê≠£Â∏∏">Ê≠£Â∏∏</option>
                        <option value="ÊåÇÂ§±">ÊåÇÂ§±</option>
                        <option value="ÂÜªÁªì">ÂÜªÁªì</option>
                        <option value="Ê≥®ÈîÄ">Ê≥®ÈîÄ</option>
                    </select>
                </div>
                <!-- Á±ªÂûã -->
                <div class="input-row-horizontal">
                    <label>Á±ªÂûã</label>
                    <select id="edit-cardType" name="cardType" required>
                        <option value="Ê≠£Âºè">Ê≠£Âºè</option>
                        <option value="‰∏¥Êó∂">‰∏¥Êó∂</option>
                    </select>
                </div>
                <!-- Ê†°Âå∫ -->
                <div class="input-row-horizontal">
                    <label>Ê†°Âå∫</label>
                    <select id="edit-campusLocation" name="campusLocation" required>
                        <option value="ÂêàËÇ•Ê†°Âå∫">ÂêàËÇ•Ê†°Âå∫</option>
                        <option value="ÂÆ£ÂüéÊ†°Âå∫">ÂÆ£ÂüéÊ†°Âå∫</option>
                    </select>
                </div>
                <!-- Ë∫´‰ªΩ -->
                <div class="input-row-horizontal">
                    <label>Ë∫´‰ªΩ</label>
                    <select id="edit-role" name="role" required>
                        <option value="">ËØ∑ÈÄâÊã©Ë∫´‰ªΩ</option>
                        <option value="Â≠¶Áîü">Â≠¶Áîü</option>
                        <option value="ÊïôÂ∏à">ÊïôÂ∏à</option>
                        <option value="ÂêéÂã§">ÂêéÂã§</option>
                        <option value="ÈôÑÂ±û‰∏≠Â∞èÂ≠¶Áîü">ÈôÑÂ±û‰∏≠Â∞èÂ≠¶Áîü</option>
                    </select>
                </div>
                <!-- ÂºÄÂç°Êó•ÊúüÔºàÂè™ËØªÔºâ -->
                <div class="input-row-horizontal">
                    <label>ÂºÄÂç°Êó•Êúü</label>
                    <input type="text" id="edit-registerDate" name="registerDate" required readonly>
                </div>
                <!-- Ë∫´‰ªΩËØÅÂè∑ -->
                <div class="input-row-horizontal">
                    <label>Ë∫´‰ªΩËØÅÂè∑</label>
                    <input type="text" id="edit-IDNumber" name="IDNumber" pattern="^\d{17}[\dXx]$" title="ËØ∑ËæìÂÖ•18‰ΩçË∫´‰ªΩËØÅÂè∑" required>
                </div>
                <!-- Âè™ËØªÔºöÊâãÊú∫Âè∑„ÄÅÈÇÆÁÆ± -->
                <div class="input-row-horizontal">
                    <label>ÊâãÊú∫Âè∑</label>
                    <input type="text" id="edit-phoneNumber" name="phoneNumber" pattern="^1[3-9]\d{9}$" title="ËØ∑ËæìÂÖ•‰ª•1ÂºÄÂ§¥ÁöÑ11‰ΩçÊúâÊïàÊâãÊú∫Âè∑" required readonly>
                </div>
                <div class="input-row-horizontal">
                    <label>ÈÇÆÁÆ±</label>
                    <input type="text" id="edit-email" name="email" title="ËØ∑ËæìÂÖ•ÊúâÊïàÈÇÆÁÆ±" readonly>
                </div>
                <!-- ÁôªÂΩïÂØÜÁ†Å -->
                <div class="input-row-horizontal">
                    <label>ÁôªÂΩïÂØÜÁ†Å</label>
                    <input type="password" id="edit-password" name="password" pattern="^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)[A-Za-z\d_.]{8,20}$" title="ÂØÜÁ†ÅÈúÄ8-20‰ΩçÔºåÂøÖÈ°ªÂåÖÂê´Â§ßÂ∞èÂÜôÂ≠óÊØçÂíåÊï∞Â≠óÔºåÂèØÂê´_Âíå.">
                    <button type="button" class="password-toggle-btn" onclick="togglePassword('edit-password', this)">ÊòæÁ§∫</button>
                </div>
                <!-- ÊîØ‰ªòÂØÜÁ†Å -->
                <div class="input-row-horizontal">
                    <label>ÊîØ‰ªòÂØÜÁ†Å</label>
                    <input type="password" id="edit-passwordPay" name="passwordPay" pattern="^\d{6}$" title="ÊîØ‰ªòÂØÜÁ†ÅÂøÖÈ°ª‰∏∫6‰ΩçÊï∞Â≠ó" required>
                    <button type="button" class="password-toggle-btn" onclick="togglePassword('edit-passwordPay', this)">ÊòæÁ§∫</button>
                </div>
                <!-- ÂçïÊ¨°ÈôêÈ¢ù -->
                <div class="input-row-horizontal">
                    <label>ÂçïÊ¨°ÈôêÈ¢ù</label>
                    <input type="number" id="edit-maxLimit" name="maxLimit" required>
                </div>
            </div>
            <div class="modal-btn-row">
                <button type="submit" class="modal-confirm-btn">‰øùÂ≠ò</button>
                <button type="button" class="modal-cancel-btn" onclick="closeAdminEditModal()">ÂèñÊ∂à</button>
            </div>
        </form>
    </div>
</div>

<script>
    // ÊâìÂºÄÁºñËæëÂºπÁ™óÔºåcard‰∏∫ÂΩìÂâçË°åÁöÑÂç°ÁâáÂØπË±°
    function openAdminEditModal(card) {
        document.getElementById('admin-edit-modal').style.display = 'flex';
        // Â°´ÂÖÖË°®Âçï
        document.getElementById('edit-cardID').value = card.cardID;
        document.getElementById('edit-name').value = card.name;
        document.getElementById('edit-personID').value = card.personID;
        document.getElementById('edit-gender').value = card.gender;
        document.getElementById('edit-department').value = card.department;
        document.getElementById('edit-major').value = card.major;
        document.getElementById('edit-status').value = card.status;
        document.getElementById('edit-cardType').value = card.cardType;
        document.getElementById('edit-campusLocation').value = card.campusLocation;
        document.getElementById('edit-role').value = card.role;
        document.getElementById('edit-registerDate').value = card.registerDate; // yyyy-MM-dd
        document.getElementById('edit-IDNumber').value = card.IDNumber;
        document.getElementById('edit-password').value = card.password || '';
        document.getElementById('edit-passwordPay').value = card.passwordPay || '';
        document.getElementById('edit-phoneNumber').value = card.phoneNumber;
        document.getElementById('edit-email').value = card.email;
        document.getElementById('edit-maxLimit').value = card.maxLimit;
    }

    function closeAdminEditModal() {
        const modal = document.getElementById('admin-edit-modal');
        modal.classList.add('closing');
        setTimeout(() => {
            modal.style.display = 'none';
            modal.classList.remove('closing');
        }, 350);
    }

    // Êèê‰∫§Ë°®Âçï
    document.getElementById('admin-edit-form').onsubmit = function (e) {
        e.preventDefault();
        const formData = new FormData(this);
        const xhr = new XMLHttpRequest();
        xhr.open("POST", "<%= request.getContextPath() %>/UpdateCardServlet", true);

        // ÂÖ≥ÈîÆË°•‰∏ÅÔºöËÆæÁΩÆ Content-Type
        //TODOÔºöËøôÈáåËÆ∞ÂΩï‰∏Ä‰∏™ÂΩìÊó∂‰øÆÁöÑbug
        xhr.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");

        xhr.onreadystatechange = function () {
            if (xhr.readyState === 4) {
                closeAdminEditModal();
                try {
                    const res = JSON.parse(xhr.responseText);
                    if (xhr.status === 200 && res.success) {
                        alert("‰øùÂ≠òÊàêÂäüÔºÅ");
                        location.reload();
                    } else {
                        alert("‰øùÂ≠òÂ§±Ë¥•Ôºö" + (res.msg || "Êú™Áü•ÈîôËØØ"));
                    }
                } catch (err) {
                    alert("ÊúçÂä°Âô®ÂºÇÂ∏∏Ôºö" + xhr.responseText);
                }
            }
        };
        xhr.send(new URLSearchParams(formData).toString());
    };

    // ÊòæÁ§∫ÂØÜÁ†ÅÊåâÈíÆ
    function togglePassword(inputId, btn) {
        const pwdInput = document.getElementById(inputId);
        if (pwdInput.type === 'password') {
            pwdInput.type = 'text';
            btn.textContent = 'ÈöêËóè';
        } else {
            pwdInput.type = 'password';
            btn.textContent = 'ÊòæÁ§∫';
        }
    }
</script>
</body>
</html>